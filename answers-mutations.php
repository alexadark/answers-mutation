<?php

/**
 * Plugin Name: answers Mutations
 * Description: Adds WPGraphQL Mutations
 * Author: Alexandra Spalato
 * Author URI: http://alexandraspalato.com/
 * Version: 1.0
 * Text Domain: answers-mutations
 * License: GPL-3
 * License URI: https://www.gnu.org/licenses/gpl-3.0.html
 */

if (!defined('ABSPATH')) {
    exit;
}



add_action('graphql_register_types', function () {
    register_graphql_mutation('resultMutation', [
        'inputFields' => [
            'emailInput' => [
                'type' => 'String',
                'description' =>'email field'
            ],
            'firstNameInput' => [
                'type' => 'String',
                'description' => 'First Name Field'
            ],
            'ageInput' => [
                'type' => 'String',
                'description' => 'Age Field'
            ],
            'slugInput' => [
                'type' => 'String',
                'description' => 'Slug Field generated by Date().now'
            ],
            'answersInput' => [
                'type' => 'String',
                'description' => 'Answers to the quizz'
            ],

            'resultsInput' => [
                'type' => ['list_of' => 'ID'],
                'description' => 'Detected Dragons'
            ]

        ],
        'outputFields' => [
            'resultSubmitted' => [
                'type' => 'Boolean',
                'description' =>'Result submission successfull or not',
            ]
        ],
        'mutateAndGetPayload' => function ($input, $context, $info) {
            // wp_send_json($input); //for debugging in graphiql

            //validate the input: make sure email is valid, do we need 3 items absolutely
            if (!is_email($input['emailInput'])) {
                throw new \GraphQL\Error\UserError('The email is invalid');
            }
            $existing_answer = get_page_by_title($input['emailInput'], 'OBJECT', 'answers');
            if ($existing_answer) {
                throw new \GraphQL\Error\UserError('You have already submitted a dragons questionnaire from this email');
            }
            $post_id = wp_insert_post([
                'post_type' => 'answers',
                'post_title' => sanitize_text_field($input['emailInput']),
                'post_name' => sanitize_text_field($input['slugInput']),
                'post_content' => sanitize_text_field($input['firstNameInput']),
                'post_status' => 'publish'

            ]);
            update_field('results_dragons', $input['resultsInput'], $post_id);
            update_field('first_name', $input['firstNameInput'], $post_id);
            update_field('user_age', $input['ageInput'], $post_id);
            return  [
                "voteSubmitted" => true,
                "slugRef" => $input['slugInput']
            ];
        }
    ]);
});